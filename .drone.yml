workspace:
  base: /root/go
  path: src/github.com/presslabs/dashboard

clone:
  git:
    image: plugins/git
    depth: 100
    tags: true

pipeline:
  dependencies:
    pull: true
    image: quay.io/presslabs/bfc:latest
    commands:
      - make dependencies

  verify-generate:
    image: quay.io/presslabs/bfc:latest
    commands:
      - make fmt generate manifests
      - git diff --exit-code

  lint:
    image: quay.io/presslabs/bfc:latest
    commands:
      - make -C app lint
      - make lint
      - helm lint chart/dashboard

  test:
    group: test
    image: quay.io/presslabs/bfc:latest
    secrets:
      - GCLOUD_CREDENTIALS
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/etc/key.json
    commands:
      - echo "${GCLOUD_CREDENTIALS}" > $GOOGLE_APPLICATION_CREDENTIALS
      - make test

  test-webapp:
    group: test
    image: quay.io/presslabs/bfc:latest
    commands:
      - cd app; make test

  # build-webapp:
  #   group: build
  #   image: quay.io/presslabs/bfc:latest
  #   commands:
  #     - cd app; make build

  build-chart:
    group: build
    image: quay.io/presslabs/bfc:latest
    commands:
      - make chart

  # bundle:
  #   image: quay.io/presslabs/bfc:latest
  #   commands:
  #     - make bundle

  publish:
    group: publish
    image: plugins/docker
    registry: quay.io
    repo: quay.io/presslabs/dashboard
    tags: [ "latest" ]
    username: presslabs+drone
    secrets:
      - source: QUAY_TOKEN
        target: DOCKER_PASSWORD
    when:
      branch: master
      event: push

  publish:
    group: publish
    image: plugins/docker
    registry: quay.io
    repo: quay.io/presslabs/dashboard
    tags: [ "${DRONE_TAG}" ]
    username: presslabs+drone
    secrets:
      - source: QUAY_TOKEN
        target: DOCKER_PASSWORD
    when:
      event: tag

  publish-chart:
    group: publish
    image: quay.io/presslabs/bfc:latest
    environment:
      - GH_USER=presslabs-bot
    commands:
      - cd chart
      - helm package dashboard
      - CHART="$(basename *.tgz)" ; MESSAGE="Publish $(basename $CHART .tgz)"
      - /usr/local/bin/gh put --skip-existing -m "$MESSAGE" "$CHART" "presslabs/charts/docs/"
    secrets:
      - GH_PASSWORD
    when:
      event: tag
